---
description:
globs:
alwaysApply: true
---

This is an app to help label photos of insects.
It's meant to run purely locally.

There's a hardware called MothBox that has a white surface and captures photos at an interval. These photos then get processed through some pyhton scripts that outputs a series folder structure where:
a session (a night), has photos, and each photo is cropped with ai into a cropped part of the image showing an insect. Each photo has a json file mentioning what was detected. Each detection is assigned a label based on the ai model. The goal of the app is to help humans finalize the detection and complete it.

The user loads folders taht have a specific structure.

Then the user can navigate through that structure, see metadata and subfolders that map to entities (see below). the goal is for the user to approve and/or further classify detections

Entities Structure:
Projects → Sites → Deployments → Nights → Photos → Patches → Detections

Filesystem structure and data model for local projects

Expected folder hierarchy when selecting the projects root:

- projects/
  - {project}/
    - {site}/
      - {deployment}/
        - {night}/
          - {photoBase}.jpg
          - {photoBase}\_botdetection.json
          - patches/
            - {photoBase}_{index}_{model}.jpg

Notes:

- Each bot detection JSON includes a shapes array; each shape has a patch_path to its patch image under night/patches.
- Example file: `project-1/site-1/deployment-1/night-1/fondoGorila_2025_01_28__04_59_06_HDR0_botdetection.json`.

In-memory entity stores (nanostores):

- projectsStore: key=id=name=project
- sitesStore: key=id=`{project}/{site}`
- deploymentsStore: key=id=`{project}/{site}/{deployment}`
- nightsStore: key=id=`{project}/{site}/{deployment}/{night}`
- photosStore: key=id=`{photoBase}.jpg`; links imageFile and botDetectionFile
- patchesStore: key=id=`{patchFilename}`; links photoId and nightId
- detectionsStore: key=id=`{patchFilename}`; parsed from JSON shapes; fields: taxon?, label? (legacy/display), score, direction, shapeType, points, detectedBy, identifiedAt?, isError?

Parsing rules:

- Normalize paths to `/`.
- Extract patch filename from shapes[i].patch_path (basename).
- Derive photo base from `*_botdetection.json` or `.jpg` filename.
- Parse taxonomy from each shape (kingdom, phylum, class, order, family, genus, species) into a Darwin Core-style `taxon` object.
- UI assumes Class = Insecta and displays Order and below (Order → Family → Genus → Species).

Selection & Actions

- Selection is per-night. Selecting a patch from a different night resets selection.
- State: `selectedPatchIdsStore: Set<string>`, `selectionNightIdStore: string | null` (src/stores/ui.ts)
- Actions (floating bar + hotkeys):
  - Identify (key: `d`)
  - Accept (key: `a`)
  - Uses `react-hotkeys-hook`; visual shortcuts via `Kbd`.

Labeling Flow

- Identify opens a cmdk dialog to choose a taxon or type free text.
- Free text is treated as a morphospecies (species-level) and inherits existing higher ranks (order/family/genus) if present.
- Typing "ERROR" marks the detection as error (`isError: true`), clears taxonomy, and stores label = 'ERROR'.
- Submitting an identification sets `detectedBy: 'user'` and `identifiedAt`.
- Accept sets `detectedBy: 'user'` without changing taxonomy/label.

Detections Fields

- `DetectionEntity`: id, patchId, photoId, nightId, taxon?, label?, score?, direction?, shapeType?, points?, detectedBy?: 'auto' | 'user', identifiedAt?, isError?
- Ingest defaults `detectedBy` to 'auto'.

Night View Composition

- Left: Summary (counts + progress), Taxonomy (auto), Taxonomy (identified). Each taxonomy list is hierarchical (Order → Family → Genus → Species) and only renders known levels (no placeholders). Auto includes an "All unapproved" aggregate.
- Right: Patch grid with selectable items, floating action bar, identify dialog.

Scrolling/Layout

- Root layout is full-height with overflow hidden.
- Night right pane uses `min-h-0` and `overflow-hidden`; grid uses `overflow-y-auto` to scroll internally.

Key Files

- Entities & ingest: `src/stores/entities/*` (e.g., `ingest.ts`, `detections.ts`)
- UI selection state: `src/stores/ui.ts`
- Night route: `src/routes/5.night/index.tsx`
- Grid & item: `src/routes/5.night/patch-grid.tsx`, `src/routes/5.night/patch-item.tsx`
- Selection bar: `src/routes/5.night/selection-bar.tsx`
- Identify dialog: `src/routes/5.night/identify-dialog.tsx`

## Labeling Workflow & Buckets

- Each night’s raw bot detection JSON and its patches form a todo list to be reviewed by a human.
- Two buckets exist:
  - Auto bucket: detections parsed from JSON (default `detectedBy: 'auto'`).
  - Identified bucket: detections that a human confirmed or labeled (`detectedBy: 'user'`).
- Actions:
  - Identify: picks/creates taxonomy (or marks ERROR), sets `detectedBy: 'user'` and moves the item to Identified bucket.
  - Accept: preserves current taxonomy/label but marks `detectedBy: 'user'`.
- Bucket math:
  - Auto/Identified sections show hierarchical taxonomy counts (O/F/G/S) for their respective bucket.
  - Error items appear under identified with label 'ERROR' and no taxonomy.
- Recent:
  - When user identifies or accepts, `identifiedAt` is set. Home shows a grid of most recent identifications across nights.
